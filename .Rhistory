# Densidades por categor铆a
p3 <- ggplot(data, aes(x = .data[[num_var]], fill = .data[[cat_var]])) +
geom_density(alpha = 0.5) +
labs(title = "Densidades", x = num_var, y = "Densidad") +
theme_minimal()
# Medias y barras de error
summary_data <- data %>%
group_by(.data[[cat_var]]) %>%
summarise(mean = mean(.data[[num_var]], na.rm = TRUE),
sd = sd(.data[[num_var]], na.rm = TRUE),
n = n(),
se = sd / sqrt(n)) %>%
mutate(lower = mean - 1.96 * se,
upper = mean + 1.96 * se)
p4 <- ggplot(summary_data, aes(x = .data[[cat_var]], y = mean,
fill = .data[[cat_var]])) +
geom_col(alpha = 0.7) +
geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
labs(title = "Medias con IC 95%", x = cat_var, y = paste("Media de", num_var)) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none")
# Combinar todos los gr谩ficos
(p1 + p2) / (p3 + p4) +
plot_annotation(title = paste("An谩lisis:", num_var, "vs", cat_var)) +
theme(plot.title = element_text(face = "bold"))
}
# 1. FUNCIN PARA MOSAICO FACETADO ROBUSTO
create_facet_mosaic <- function(var_x, var_y, data) {
if(var_x == var_y) return(NULL)
# Preparar datos para mosaico (como son factores es un poco engorrioso)
mosaic_data <- data %>%
# count(!!sym(var_x), !!sym(var_y)) %>%
count(.data[[var_x]], .data[[var_y]]) %>%
# group_by(!!sym(var_x)) %>%
group_by(.data[[var_x]]) %>%
mutate(
total_x = sum(n),
prop = n / total_x,
# label = if_else(prop > 0.08, paste0(round(prop * 100, 1), "%"), "")
label = paste0(round(prop * 100, 1), "%")
) %>%
ungroup()
p <-
ggplot(mosaic_data, aes(x = "", y = prop, fill = !!sym(var_y))) +
geom_col(position = "stack", alpha = 0.8, color = "white", linewidth = 0.3) +
geom_text(aes(label = label),
position = position_stack(vjust = 0.5),
size = 3, color = "black", fontface = "bold") +
facet_grid(~ .data[[var_x]], scales = "free_x", space = "free_x") +
# scale_y_continuous(labels = aes(label), expand = c(0, 0)) + # `breaks` and `labels` have different lengths. No s茅 por qu茅
scale_y_continuous() +
scale_fill_viridis_d(option = "plasma") +
labs(
x = var_x,
y = paste("Distribuci贸n de", var_y),
title = paste("Barras apiladas:", var_x, "vs", var_y),
fill = var_y
) +
theme_minimal() +
theme(
axis.text.x = element_blank(),
axis.ticks.x = element_blank(),
panel.spacing = unit(0.1, "lines"),
strip.text = element_text(angle = 45, size = 8, face = "bold"),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
plot.title = element_text(face = "bold")
)
list(
plot = p,
table = mosaic_data
)
}
create_facet_mosaic3 <- function(var_x, var_y, var_z, data) {
if(length(unique(c(var_x, var_y, var_z))) < 3) return(NULL)
mosaic_data <- data %>%
count(.data[[var_x]], .data[[var_y]], .data[[var_z]]) %>%
group_by(.data[[var_x]], .data[[var_y]]) %>%
mutate(
total_xy = sum(n),
prop = n / total_xy,
label = if_else(prop > 0.08, paste0(round(prop * 100, 1), "%"), "")
) %>%
ungroup()
p <-
ggplot(
mosaic_data,
aes(x = .data[[var_y]], y = prop, fill = .data[[var_z]])
) +
geom_col(position = "stack", color = "white", linewidth = 0.2) +
geom_text(
aes(label = label),
position = position_stack(vjust = 0.5),
size = 3,
color = "black",
fontface = "bold"
) +
facet_grid(~ .data[[var_x]], scales = "free_x", space = "free_x", switch = "x") +
# scale_fill_viridis_d(option = "plasma") +
labs(
x = var_y,
y = paste("Distribuci贸n dentro de", var_y, "por", var_z),
title = paste("Mosaico con tercera variable:", var_x, "vs", var_y, "vs", var_z),
fill = var_z
) +
theme_minimal() +
theme(
strip.text = element_text(face = "bold"),
axis.text.x = element_text(angle = 45, hjust = 1),
panel.grid = element_blank(),
plot.title = element_text(face = "bold")
) + escala_accion()
list(
plot = p,
table = mosaic_data
)
}
# 2. FUNCIN PARA HEATMAP ESTADSTICO
create_statistical_heatmap <- function(var_x, var_y, data) {
if(var_x == var_y) return(NULL)
# Calcular tabla de contingencia y residuos
cont_table <- table(data[[var_x]], data[[var_y]])
expected <- outer(rowSums(cont_table), colSums(cont_table)) / sum(cont_table)
residuals <- (cont_table - expected) / sqrt(expected)
# Convertir a data frame
resid_data <- as.data.frame(as.table(residuals))
names(resid_data) <- c("Var1", "Var2", "Residual")
freq_data <- as.data.frame(cont_table)
names(freq_data) <- c("Var1", "Var2", "Freq")
# Combinar datos
plot_data <- freq_data %>%
left_join(resid_data, by = c("Var1", "Var2")) %>%
mutate(
Significance = case_when(
abs(Residual) > 2 ~ "Muy significativo",
abs(Residual) > 1.5 ~ "Significativo",
TRUE ~ "No significativo"
)
)
p <-
ggplot(plot_data, aes(x = Var2, y = Var1, fill = Residual)) +
geom_tile(color = "white", linewidth = 0.8, alpha = 0.9) +
geom_text(aes(label = paste0("n=", Freq, "\n", round(Residual, 2))),
size = 2.8, color = "black", fontface = "bold") +
scale_fill_gradient2(
low = "blue", mid = "white", high = "red",
midpoint = 0,
name = "Residuales\nestandarizados"
) +
labs(
x = var_y,
y = var_x,
title = paste("Heatmap:", var_x, "vs", var_y),
subtitle = "Rojo: m谩s frecuente de lo esperado | Azul: menos frecuente"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1, face = "bold"),
axis.text.y = element_text(face = "bold"),
panel.grid = element_blank(),
plot.title = element_text(face = "bold")
)
list(
plot = p,
table = freq_data
)
}
# 3. FUNCIN PARA HEATMAP DE PROPORCIONES DOBLE
create_double_heatmap <- function(var_x, var_y, data) {
if(var_x == var_y) return(NULL)
# Calcular diferentes m茅tricas de proporci贸n
freq_data <- data %>%
count(!!sym(var_x), !!sym(var_y)) %>%
group_by(!!sym(var_y)) %>%
mutate(prop_col = n / sum(n)) %>%  # Proporci贸n por columna
group_by(!!sym(var_x)) %>%
mutate(prop_row = n / sum(n)) %>%  # Proporci贸n por fila
ungroup() %>%
mutate(prop_total = n / sum(n))    # Proporci贸n total
# Heatmap de proporciones por columna
p_col <- ggplot(freq_data, aes(x = !!sym(var_y), y = !!sym(var_x), fill = prop_col, labels=prop_col)) +
geom_tile(color = "white", linewidth = 0.5, alpha = 0.9) +
geom_text(aes(label = paste0(round(prop_col * 100, 1), "%")),
size = 3.2, color = "black", fontface = "bold") +
scale_fill_viridis_c(option = "plasma", name = "Prop. Columna") +
labs(
title = paste("Proporci贸n por", var_y),
x = var_y,
y = var_x
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
panel.grid = element_blank()
)
# Heatmap de proporciones por fila
p_row <- ggplot(freq_data, aes(x = !!sym(var_y), y = !!sym(var_x), fill = prop_row, labels=prop_col)) +
geom_tile(color = "white", linewidth = 0.5, alpha = 0.9) +
geom_text(aes(label = paste0(round(prop_row * 100, 1), "%")),
size = 3.2, color = "black", fontface = "bold") +
scale_fill_viridis_c(option = "viridis", name = "Prop. Fila") +
labs(
title = paste("Proporci贸n por", var_x),
x = var_y,
y = var_x
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
panel.grid = element_blank(),
plot.title = element_text(face = "bold")
)
# Combinar los dos heatmaps
p <-
p_col + p_row + plot_layout(ncol = 1) +
plot_annotation(title = paste("Heatmaps (proporciones):", var_x, "y", var_y))
list(
plot = p,
table = freq_data
)
}
# 4. FUNCIN PARA ANLISIS COMPACTO
create_compact_analysis <- function(var_x, var_y, data) {
if(var_x == var_y) return(NULL)
# Crear los tres tipos de gr谩ficos
mosaic_plot <- create_facet_mosaic(var_x, var_y, data)$plot
statistical_heatmap <- create_statistical_heatmap(var_x, var_y, data)$plot
double_heatmap <- create_double_heatmap(var_x, var_y, data)$plot
# Combinar en un dise帽o compacto
design <- "
AABB
AABB
CCCC
CCCC
"
(mosaic_plot + statistical_heatmap + double_heatmap) +
plot_layout(design = design) +
plot_annotation(
title = paste("ANLISIS VISUAL COMPLETO:", var_x, "&", var_y),
theme = theme(
plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
plot.background = element_rect(fill = "white", color = NA)
)
)
}
results <- map(cat_combs3_accion, ~ create_facet_mosaic3(.x[1], .x[2], .x[3], data))
mosaic_plots3 <- compact(map(results, "plot"))
mosaic_plots3[[1]]
data <- data |> mutate(accion = factor(if_else(accion=='No HM', 'No HM', 'HM'), levels = c('No HM', 'HM')))
table(data$guantes, data$accion)
results <- map(cat_combs3_accion, ~ create_facet_mosaic3(.x[1], .x[2], .x[3], data))
mosaic_plots3 <- compact(map(results, "plot"))
mosaic_plots3[[1]]
saveRDS(list(colores_accion = colores_accion, escala_accion = escala_accion), "raw/HM_colores.RDA")
# Filtrar combinaciones que contengan 'accion' y asegurar que 'accion' sea la tercera
cat_combs3_accion <- cat_combs3 %>%
purrr::keep(~ "accion" %in% .x) %>%   # mantener solo combinaciones con 'accion'
purrr::map(~ c(setdiff(.x, "accion"), "accion")) %>%  # reordenar para que 'accion' sea la tercera
purrr::map(unique) %>%                # asegurar elementos 煤nicos
purrr::map(~ if(length(.x) == 3) .x else .x[1:3]) %>% # truncar si hay m谩s de 3
unique()                              # eliminar duplicados
length(mosaic_plots3)
results <- map(cat_combs3_accion, ~ create_facet_mosaic3(.x[1], .x[2], .x[3], data))
mosaic_tables3 <- compact(map(results, "table"))
mosaic_plots3 <- compact(map(results, "plot"))
length(mosaic_plots3)
# 3. Estructura y missing
gg_miss_var(data, show_pct = TRUE) + labs(title = "% de valores sin informar") +
theme(
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
plot.title = element_text(
hjust   = 0.5,          # centrado
size    = 14,
face    = "bold"
)
)
#' - [Inicio](../index.html)
#' - [Ingesta de datos](00_main.html)
#' - [Cruce de variables (descriptivo)](01_eda.html)
## ---- Set up, include=FALSE ----
wd <- "C:/Users/mario.camacho/OneDrive - UFV/Hospitales CAM"
setwd(wd)                       # cambia el WD de la sesi贸n
knitr::opts_knit$set(root.dir = wd)  # mantiene el WD en todos los chunks al render
source('scr/zz_libraries.R')
source('scr/zz_funciones.R')
## ---- Set up, include=FALSE ----
wd <- "C:/Users/mario.camacho/OneDrive - UFV/Hospitales CAM"
wd <- file.path(wd, "Sureste/Bea Isidoro 202511/20251118 Adherencia Higiene Manos en Centro de Simulaci贸n Cl铆nica")
setwd(wd)                       # cambia el WD de la sesi贸n
source('scr/zz_libraries.R')
source('scr/zz_funciones.R')
data <- readRDS("raw/data.rds")
HM_colores <- readRDS("raw/HM_colores.RDA")
colores_accion <- HM_colores$colores_accion
escala_accion <- HM_colores$escala_accion
## ---- Preparativos, include=FALSE ----
num_vars <- names(data)[sapply(data, is.numeric)]
cat_vars <- names(data)[sapply(data, is.factor)]
cat_combs <- combn(cat_vars, 2, simplify = FALSE)
cat_combs3 <- combn(cat_vars, 3, simplify = FALSE)
mix_combs <- expand.grid(num_vars = num_vars, cat_vars = cat_vars, stringsAsFactors = FALSE)
# Crear densidades de las num茅ricas por categ贸ricas
density_plots <- map2(mix_combs$num_vars, mix_combs$cat_vars, ~ analysis_num_cat(.x, .y, data))
# Crear mosaicos robustos
results <- map(cat_combs, ~ create_facet_mosaic(.x[1], .x[2], data))
mosaic_tables <- compact(map(results, "table"))
mosaic_plots <- compact(map(results, "plot"))
# Filtrar combinaciones que contengan 'accion' y asegurar que 'accion' sea la tercera
cat_combs3_accion <- cat_combs3 %>%
purrr::keep(~ "accion" %in% .x) %>%   # mantener solo combinaciones con 'accion'
purrr::map(~ c(setdiff(.x, "accion"), "accion")) %>%  # reordenar para que 'accion' sea la tercera
purrr::map(unique) %>%                # asegurar elementos 煤nicos
purrr::map(~ if(length(.x) == 3) .x else .x[1:3]) %>% # truncar si hay m谩s de 3
unique()                              # eliminar duplicados
results <- map(cat_combs3_accion, ~ create_facet_mosaic3(.x[1], .x[2], .x[3], data))
mosaic_tables3 <- compact(map(results, "table"))
mosaic_plots3 <- compact(map(results, "plot"))
# Crear heatmaps estad铆sticos
results <- map(cat_combs, ~ create_statistical_heatmap(.x[1], .x[2], data))
heatmap_tables <- compact(map(results, "table"))
heatmap_plots <- compact(map(results, "plot"))
# Crear heatmaps de proporciones
results <- map(cat_combs, ~ create_double_heatmap(.x[1], .x[2], data))
double_heatmaps_tables <- compact(map(results, "table"))
double_heatmaps_plots <- compact(map(results, "plot"))
# 3. Estructura y missing
gg_miss_var(data, show_pct = TRUE) + labs(title = "% de valores sin informar") +
theme(
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
plot.title = element_text(
hjust   = 0.5,          # centrado
size    = 14,
face    = "bold"
)
)
vis_miss(data)
# 4. Matriz de correlaciones y scatter plots
ggpairs(data)
if (length(num_vars) > 0) {
data %>%
select(where(is.numeric)) %>%
tidyr::pivot_longer(everything(), names_to = "variable", values_to = "valor") %>%
ggplot(aes(x = valor)) +
geom_histogram(
bins = 30,
fill = "#4E79A7",
color = "white",
alpha = 0.9
) +
facet_wrap(~ variable, scales = "free", ncol = 3) +
labs(
title = "Distribuci贸n de variables num茅ricas",
subtitle = "Histogramas individuales por variable",
x = "Valor",
y = "Frecuencia"
) +
theme_minimal(base_size = 12) +
theme(
strip.text = element_text(face = "bold"),
plot.title = element_text(face = "bold", size = 14),
plot.subtitle = element_text(color = "gray40"),
panel.grid.minor = element_blank()
)
}
if (length(cat_vars) > 0) {
data %>%
dplyr::select(where(~is.factor(.) || is.character(.))) %>%
tidyr::pivot_longer(
cols = everything(),
names_to = "variable",
values_to = "categoria"
) %>%
ggplot(aes(x = categoria)) +
geom_bar(fill = "#59A14F", alpha = 0.9) +
facet_wrap(~ variable, scales = "free_x", ncol = 3) +
labs(
title = "Distribuci贸n de variables categ贸ricas",
subtitle = "Frecuencia por categor铆a",
x = "Categor铆a",
y = "Recuento"
) +
theme_minimal(base_size = 12) +
theme(
strip.text = element_text(face = "bold"),
plot.title = element_text(face = "bold", size = 14),
plot.subtitle = element_text(color = "gray40"),
axis.text.x = element_text(angle = 45, hjust = 1),
panel.grid.minor = element_blank()
)
}
if (length(cat_vars) > 0) {
data %>%
dplyr::select(where(~is.factor(.) || is.character(.))) %>%
tidyr::pivot_longer(
cols = everything(),
names_to = "variable",
values_to = "categoria"
) %>%
ggplot(aes(x = categoria)) +
geom_bar(fill = "#59A14F", alpha = 0.9) +
facet_wrap(~ variable, scales = "free_x", ncol = 3) +
labs(
title = "Distribuci贸n de variables categ贸ricas",
subtitle = "Frecuencia por categor铆a",
x = "Categor铆a",
y = "Recuento"
) +
theme_minimal(base_size = 12) +
theme(
strip.text = element_text(face = "bold"),
plot.title = element_text(face = "bold", size = 14),
plot.subtitle = element_text(color = "gray40"),
axis.text.x = element_text(angle = 45, hjust = 1),
panel.grid.minor = element_blank()
)
}
if(length(cat_vars) > 0) {
data %>%
dplyr::select(where(~is.factor(.) || is.character(.))) %>%
dplyr::mutate(across(everything(), as.character)) %>%   # <-- fuerza a character
tidyr::pivot_longer(
cols = everything(),
names_to = "variable",
values_to = "categoria"
) %>%
ggplot(aes(x = categoria)) +
geom_bar(fill = "#59A14F", alpha = 0.9) +
facet_wrap(~ variable, scales = "free_x", ncol = 3) +
labs(
title = "Distribuci贸n de variables categ贸ricas",
subtitle = "Frecuencia por categor铆a",
x = "Categor铆a",
y = "Recuento"
) +
theme_minimal(base_size = 12) +
theme(
strip.text = element_text(face = "bold"),
plot.title = element_text(face = "bold", size = 14),
plot.subtitle = element_text(color = "gray40"),
axis.text.x = element_text(angle = 45, hjust = 1),
panel.grid.minor = element_blank()
)
}
# Para las variables categ贸ricas
if (length(cat_vars) > 0) {
data  |> select(where(~is.factor(.) || is.character(.))) |> tidyr::pivot_longer(cols = everything(), names_to = "variable", values_to = "categoria") %>%
ggplot(aes(x = categoria)) +
geom_bar(fill = "#59A14F", alpha = 0.9) +
facet_wrap(~ variable, scales = "free_x", ncol = 3) +
labs(title = "Distribuci贸n de variables categ贸ricas",
subtitle = "Frecuencia por categor铆a",
x = "Categor铆a",
y = "Recuento"
) +
theme_minimal()
}
# Para las variables categ贸ricas
if (length(cat_vars) > 0) {
data  |> select(where(~is.factor(.) || is.character(.))) |>
dplyr::mutate(across(everything(), ~factor(as.character(.)))) |> tidyr::pivot_longer(cols = everything(), names_to = "variable", values_to = "categoria") %>%
ggplot(aes(x = categoria)) +
geom_bar(fill = "#59A14F", alpha = 0.9) +
facet_wrap(~ variable, scales = "free_x", ncol = 3) +
labs(title = "Distribuci贸n de variables categ贸ricas",
subtitle = "Frecuencia por categor铆a",
x = "Categor铆a",
y = "Recuento"
) +
theme_minimal()
}
library(GGally)
library(ggplot2)
# ggpairs personalizado
ggpairs(
data,
# Define qu茅 mostrar en cada parte
upper = list(
continuous = wrap("cor", size = 4),   # correlaci贸n para variables num茅ricas
combo = wrap("box_no_facet", alpha = 0.7) # combinaci贸n num-cat
),
lower = list(
continuous = wrap("points", alpha = 0.5, size = 1),
combo = wrap("dot_no_facet", alpha = 0.7)
),
diag = list(
continuous = wrap("densityDiag", fill = "#4E79A7", alpha = 0.7),
discrete = wrap("barDiag", fill = "#59A14F", alpha = 0.8)
),
axisLabels = "show",        # mostrar nombres de variables
title = "Matriz exploratoria de variables",
labeller = label_wrap_gen(15) # cortar nombres largos
) +
theme_minimal(base_size = 12) +
theme(
strip.text = element_text(face = "bold"),
plot.title = element_text(face = "bold", size = 14),
panel.grid.minor = element_blank()
)
# Mostrar heatmaps de proporciones
if(length(double_heatmaps_plots) > 0) {
cat("\n MOSTRANDO HEATMAPS DE PROPORCIONES:\n")
for(p in double_heatmaps_plots) {
print(p)
}
wrap_plots(double_heatmaps_plots[1:length(double_heatmaps_plots)], ncol = 1)
}
double_heatmaps_tables
create_facet_mosaic |> View
create_facet_mosaic |> View()
